<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tra cứu MSSV</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    input,button{padding:8px 10px;font-size:14px}
    .muted{opacity:.75}
    .card{border:1px solid #ddd;border-radius:12px;padding:16px;margin-top:16px;max-width:860px}
    .grid{display:grid;grid-template-columns:160px 1fr;gap:8px 16px}
    .label{font-weight:600;color:#333}
    .notfound{color:#b00020}
    .loading{opacity:.7}
  </style>
  <script defer>
    const GAS_URL = 'https://script.google.com/a/macros/utt.edu.vn/s/AKfycbzcOKkaedd-J8Hi41IDSf2e1kMwLrfj3wseZxPZomsRhpaaXIWIiExbxNkFir6RLfpM/exec'; // <- thay

    const FIELDS = [
      ['STT','STT'],
      ['HODEM','Họ đệm'],
      ['TEN','Tên'],
      ['HOVATEN','Họ và tên'],
      ['LOP','Lớp'],
      ['NGAYSINH','Ngày sinh'],
      ['DIEM','Điểm'],
      ['XEPLOAI','Xếp loại'],
    ];

    function escapeHtml(str){
      return String(str ?? '').replace(/[&<>"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));
    }

    function jsonp(url){
      return new Promise((resolve,reject)=>{
        const cbName = 'cb_' + Math.random().toString(36).slice(2);
        const sep = url.includes('?') ? '&' : '?';
        const script = document.createElement('script');
        script.src = `${url}${sep}callback=${cbName}`;
        script.async = true;

        const timeout = setTimeout(()=>{ cleanup(); reject(new Error('JSONP timeout')); }, 15000);

        window[cbName] = (data)=>{ clearTimeout(timeout); cleanup(); resolve(data); };
        script.onerror = ()=>{ clearTimeout(timeout); cleanup(); reject(new Error('JSONP load error')); };

        function cleanup(){ try{ delete window[cbName]; }catch(_){ window[cbName]=undefined; } script.remove(); }

        document.head.appendChild(script);
      });
    }

    function render(row){
      const result = document.getElementById('result');
      if(!row){
        result.innerHTML = `<div class="card notfound">Không tìm thấy sinh viên với MSSV đã nhập.</div>`;
        return;
      }
      const html = FIELDS.map(([k,label])=>`
        <div class="label">${escapeHtml(label)}:</div>
        <div>${escapeHtml(row[k])}</div>
      `).join('');
      result.innerHTML = `<div class="card"><div class="grid">${html}</div></div>`;
    }

    async function findStudent(){
      const input = document.getElementById('msvInput');
      const status = document.getElementById('status');
      const msv = (input.value || '').trim();
      if(!msv){ status.textContent = 'Nhập MSSV để tra cứu.'; render(null); return; }

      status.textContent = 'Đang tra cứu...'; status.classList.add('loading');

      try{
        const ts = Date.now();
        const url = `${GAS_URL}?api=lookup&msv=${encodeURIComponent(msv)}&_=${ts}`;
        const data = await jsonp(url); // param callback=... sẽ tự gắn bên trong

        if(!data || data.ok === false){
          status.textContent = 'Lỗi: ' + (data && data.error ? data.error : 'API error');
          render(null);
          return;
        }
        status.textContent = data.found ? 'Đã tìm thấy 1 kết quả.' : 'Không tìm thấy kết quả.';
        render(data.data || null);
      }catch(err){
        status.textContent = 'Lỗi: ' + err.message;
        render(null);
      }finally{
        status.classList.remove('loading');
      }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      document.getElementById('btnFind').addEventListener('click', findStudent);
      document.getElementById('msvInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter') findStudent(); });
    });
  </script>
</head>
<body>
  <h1>Tra cứu thông tin sinh viên theo MSSV</h1>
  <div class="row">
    <label for="msvInput">Nhập MSSV:</label>
    <input id="msvInput" type="text" placeholder="VD: 2025xxxx" />
    <button id="btnFind">Tra cứu</button>
    <span id="status" class="muted"></span>
  </div>
  <div id="result"></div>
</body>
</html>
