<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tra cứu MSSV</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    input,button{padding:8px 10px;font-size:14px}
    .muted{opacity:.75}
    .card{border:1px solid #ddd;border-radius:12px;padding:16px;margin-top:16px;max-width:860px}
    .grid{display:grid;grid-template-columns:160px 1fr;gap:8px 16px}
    .label{font-weight:600;color:#333}
    .notfound{color:#b00020}
    .loading{opacity:.7}
    .debug{margin-top:12px;font-size:13px}
    .debug a{word-break:break-all}
  </style>
  <script defer>
    // ========= CẤU HÌNH =========
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzcOKkaedd-J8Hi41IDSf2e1kMwLrfj3wseZxPZomsRhpaaXIWIiExbxNkFir6RLfpM/exec';
    // ============================

    const FIELDS = [
      ['STT','STT'],
      ['HODEM','Họ đệm'],
      ['TEN','Tên'],
      ['HOVATEN','Họ và tên'],
      ['LOP','Lớp'],
      ['NGAYSINH','Ngày sinh'],
      ['DIEM','Điểm'],
      ['XEPLOAI','Xếp loại'],
    ];

    function escapeHtml(str){
      return String(str ?? '').replace(/[&<>"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));
    }

    // JSONP helper: thêm <script> với callback ngẫu nhiên
    function jsonp(url){
      return new Promise((resolve,reject)=>{
        const cbName = 'cb_' + Math.random().toString(36).slice(2);
        const sep = url.includes('?') ? '&' : '?';
        const cacheBust = '_=' + Date.now() + Math.random().toString(36).slice(2);
        const fullUrl = `${url}${sep}callback=${cbName}&${cacheBust}`;

        // Hiển thị link debug & log
        const debugLink = document.getElementById('debugLink');
        debugLink.innerHTML = `Gọi: <a href="${escapeHtml(fullUrl)}" target="_blank" rel="noopener"> ${escapeHtml(fullUrl)} </a>`;

        const script = document.createElement('script');
        script.src = fullUrl;
        script.async = true;
        script.referrerPolicy = 'no-referrer'; // giảm rủi ro chặn vì referrer

        let done = false;

        const timeout = setTimeout(()=>{
          if (done) return;
          done = true;
          cleanup();
          reject(new Error('JSONP timeout (không nhận được phản hồi trong 15s)'));
        }, 15000);

        window[cbName] = (data)=>{
          if (done) return;
          done = true;
          clearTimeout(timeout);
          cleanup();
          resolve(data);
        };

        script.onerror = ()=>{
          if (done) return;
          done = true;
          clearTimeout(timeout);
          cleanup();
          reject(new Error('JSONP load error (trình duyệt không tải được script từ Google Apps Script)'));
        };

        function cleanup(){
          try{ delete window[cbName]; }catch(_){ window[cbName]=undefined; }
          script.remove();
        }

        document.head.appendChild(script);
      });
    }

    function render(row){
      const result = document.getElementById('result');
      if(!row){
        result.innerHTML = `<div class="card notfound">Không tìm thấy sinh viên với MSSV đã nhập.</div>`;
        return;
      }
      const html = FIELDS.map(([k,label])=>`
        <div class="label">${escapeHtml(label)}:</div>
        <div>${escapeHtml(row[k])}</div>
      `).join('');
      result.innerHTML = `<div class="card"><div class="grid">${html}</div></div>`;
    }

    async function findStudent(){
      const input  = document.getElementById('msvInput');
      const status = document.getElementById('status');
      const result = document.getElementById('result');
      const msvRaw = (input.value || '').trim();

      if(!msvRaw){
        status.textContent = 'Nhập MSSV để tra cứu.';
        render(null);
        return;
      }

      status.textContent = 'Đang tra cứu...';
      status.classList.add('loading');
      result.innerHTML = '';

      try{
        // LƯU Ý: không encode đúp — dùng encodeURIComponent chỉ cho msv
        const url = `${GAS_URL}?api=lookup&msv=${encodeURIComponent(msvRaw)}`;

        const data = await jsonp(url);
        if (!data || data.ok === false){
          status.textContent = 'Lỗi: ' + (data && data.error ? data.error : 'API error');
          render(null);
          return;
        }

        status.textContent = data.found ? 'Đã tìm thấy 1 kết quả.' : 'Không tìm thấy kết quả.';
        render(data.data || null);
      }catch(err){
        status.textContent = 'Lỗi: ' + err.message + '. Hãy bấm link debug bên dưới để mở trực tiếp xem phản hồi.';
        render(null);
      }finally{
        status.classList.remove('loading');
      }
    }

    document.addEventListener('DOMCon
