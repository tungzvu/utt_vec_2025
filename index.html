<script>
  const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyxnxp7hWtKGHXYKf5gv5Xvoi9R1v5SD30RImpkS1D82alR4xp7hirEm3je6pqE9A2UYA/exec';

  // JSONP helper: trả Promise resolve với data
  function jsonp(url) {
    return new Promise((resolve, reject) => {
      const cbName = 'cb_' + Math.random().toString(36).slice(2);
      const sep = url.includes('?') ? '&' : '?';
      const script = document.createElement('script');
      script.src = `${url}${sep}callback=${cbName}`;
      script.async = true;

      let timeout = setTimeout(() => {
        cleanup();
        reject(new Error('JSONP timeout'));
      }, 15000);

      window[cbName] = (data) => {
        clearTimeout(timeout);
        cleanup();
        resolve(data);
      };

      script.onerror = () => {
        clearTimeout(timeout);
        cleanup();
        reject(new Error('JSONP load error'));
      };

      function cleanup() {
        delete window[cbName];
        script.remove();
      }

      document.head.appendChild(script);
    });
  }

  function escapeHtml(str){
    return String(str).replace(/[&<>"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));
  }

  async function init(){
    const classSelect = document.getElementById('classSelect');
    const statusEl    = document.getElementById('status');

    statusEl.textContent = 'Đang tải danh sách lớp...';
    try{
      const data = await jsonp(WEB_APP_URL + '?action=classes');
      if(!data.ok) throw new Error(data.error || 'Không lấy được danh sách lớp');
      classSelect.innerHTML = '<option value="">-- Chọn lớp --</option>' +
        (data.classes || []).map(c => `<option value="${encodeURIComponent(c)}">${c}</option>`).join('');
      statusEl.textContent = `Đã tải ${data.classes.length} lớp.`;
    }catch(err){
      statusEl.textContent = 'Lỗi: ' + err.message;
      classSelect.innerHTML = '<option value="">(lỗi tải lớp)</option>';
    }
  }

  async function loadList(){
    const classSelect = document.getElementById('classSelect');
    const statusEl    = document.getElementById('status');
    const table       = document.getElementById('resultTable');
    const tbody       = table.querySelector('tbody');

    const val = decodeURIComponent(classSelect.value || '');
    if(!val){ statusEl.textContent = 'Hãy chọn một lớp.'; return; }

    statusEl.textContent = 'Đang tải danh sách...';
    table.hidden = true; tbody.innerHTML = '';
    try{
      const data = await jsonp(WEB_APP_URL + '?action=list&class=' + encodeURIComponent(val));
      if(!data.ok) throw new Error(data.error || 'Không lấy được dữ liệu');
      const rows = data.data || [];
      if(rows.length === 0){
        statusEl.textContent = 'Không có dữ liệu cho lớp đã chọn.';
        return;
      }
      tbody.innerHTML = rows.map((r,i)=>`
        <tr>
          <td>${i+1}</td>
          <td>${escapeHtml(r.StudentID||'')}</td>
          <td>${escapeHtml(r.FullName||'')}</td>
          <td>${escapeHtml(r.Gender||'')}</td>
          <td>${escapeHtml(r.DOB||'')}</td>
          <td>${escapeHtml(r.Phone||'')}</td>
          <td>${escapeHtml(r.Email||'')}</td>
        </tr>
      `).join('');
      table.hidden = false;
      statusEl.textContent = `Tìm thấy ${rows.length} bản ghi.`;
    }catch(err){
      statusEl.textContent = 'Lỗi: ' + err.message;
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('btnLoad').addEventListener('click', loadList);
    init();
  });
</script>
